# üóìÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–ø–∏—Å–æ–∫ v8.0

## üö® –ü–†–û–ë–õ–ï–ú–ê (–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø)

### –¢–µ–∫—É—â–∏–µ –±–∞–≥–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –ª–∏–º–∏—Ç–æ–≤:
1. **–õ–∏–º–∏—Ç—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - —Å–±—Ä–æ—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –¥–Ω–µ–π** - PREMIUM –ø–µ—Ä–∏–æ–¥ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞–∫ `+1 –¥–µ–Ω—å` –æ—Ç –º–æ–º–µ–Ω—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. **–ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –º–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º** - –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö  
4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ–Ω–æ–≤—ã–π —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –Ω–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

## üéØ –¶–ï–õ–¨

–°–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–ø–∏—Å–æ–∫ –≥–¥–µ:
- **FREE**: –ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è 1 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:00 –ú–°–ö
- **PREMIUM**: –ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 –ú–°–ö
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å** —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–¢–æ—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏

---

## üìã –ó–ê–î–ê–ß–ò

### ‚úÖ –≠–¢–ê–ü 1: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ö–£–©–ò–• –ë–ê–ì–û–í

#### 1.1 –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø—Ä–æ–±–ª–µ–º—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `Stanislav` –≤ –ë–î
- [ ] –í—ã—è—Å–Ω–∏—Ç—å –ø–æ—á–µ–º—É –ª–∏–º–∏—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 9 –≤–º–µ—Å—Ç–æ 20
- [ ] –ù–∞–π—Ç–∏ –≥–¥–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞

#### 1.2 –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (HOTFIX)
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤
- [ ] –°–æ–∑–¥–∞—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É `Stanislav` –¥–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ä–µ–ª–∏–∑–∞

### ‚úÖ –≠–¢–ê–ü 2: –ù–û–í–ê–Ø –ö–ê–õ–ï–ù–î–ê–†–ù–ê–Ø –õ–û–ì–ò–ö–ê

#### 2.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–±—Ä–æ—Å–∞ –ø–µ—Ä–∏–æ–¥–æ–≤
```python
# –°–¢–ê–†–ê–Ø –ª–æ–≥–∏–∫–∞ (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):
if today > period_end_date:
    await self._reset_limits(user_id, plan_type)

# –ù–û–í–ê–Ø –ª–æ–≥–∏–∫–∞ (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø):
if self._should_reset_calendar_limits(subscription, today):
    await self._reset_calendar_limits(user_id, plan_type, today)
```

#### 2.2 –§—É–Ω–∫—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
- [ ] `_should_reset_calendar_limits()` - –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–µ–Ω –ª–∏ —Å–±—Ä–æ—Å
- [ ] `_reset_calendar_limits()` - —Å–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
- [ ] `_get_next_reset_date()` - –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–ª–µ–¥—É—é—â—É—é –¥–∞—Ç—É —Å–±—Ä–æ—Å–∞
- [ ] `_get_moscow_time()` - —Ä–∞–±–æ—Ç–∞ —Å –º–æ—Å–∫–æ–≤—Å–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º

#### 2.3 –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã
```python
def _get_next_reset_date(self, plan_type: str, current_date: date) -> date:
    """–ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤"""
    if plan_type == 'premium':
        # PREMIUM: —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å –≤ 00:00 –ú–°–ö
        return current_date + timedelta(days=1)
    else:
        # FREE: –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –≤ 00:00 –ú–°–ö
        if current_date.month == 12:
            return date(current_date.year + 1, 1, 1)
        else:
            return date(current_date.year, current_date.month + 1, 1)
```

### ‚úÖ –≠–¢–ê–ü 3: –§–û–ù–û–í–´–ô –°–ë–†–û–° –õ–ò–ú–ò–¢–û–í

#### 3.1 –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞
- [ ] –°–æ–∑–¥–∞—Ç—å async –∑–∞–¥–∞—á—É `periodic_limits_reset()`
- [ ] –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏
- [ ] –°–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ 00:05 –ú–°–ö

#### 3.2 –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–±—Ä–æ—Å–∞
- [ ] –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø—Ä–∏ —Å–±–æ—è—Ö

### ‚úÖ –≠–¢–ê–ü 4: –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–î –ò –°–•–ï–ú–´

#### 4.1 –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ subscriptions
```sql
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS 
    last_reset_date DATE DEFAULT CURRENT_DATE;
    
ALTER TABLE subscriptions ADD COLUMN IF NOT EXISTS 
    timezone VARCHAR(50) DEFAULT 'Europe/Moscow';
```

#### 4.2 –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö `period_end` –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `last_reset_date` –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- [ ] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤

### ‚úÖ –≠–¢–ê–ü 5: –£–õ–£–ß–®–ï–ù–ò–ï UX

#### 5.1 –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
```python
# PREMIUM
"üìä –û—Å—Ç–∞—Ç–æ–∫ –ø–∏—Å–µ–º —Å–µ–≥–æ–¥–Ω—è: 15/20\nüïê –õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—Å—è –∑–∞–≤—Ç—Ä–∞ –≤ 00:00"

# FREE  
"üìä –û—Å—Ç–∞—Ç–æ–∫ –ø–∏—Å–µ–º –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ: 1/3\nüïê –õ–∏–º–∏—Ç –æ–±–Ω–æ–≤–∏—Ç—Å—è 1 –¥–µ–∫–∞–±—Ä—è –≤ 00:00"
```

#### 5.2 –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] `/limits` - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ –ª–∏–º–∏—Ç—ã –∏ –≤—Ä–µ–º—è —Å–±—Ä–æ—Å–∞
- [ ] `/subscription` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–µ
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±—Ä–æ—Å–µ –ª–∏–º–∏—Ç–æ–≤

---

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø

### –ù–æ–≤—ã–π –∫–ª–∞—Å—Å CalendarSubscriptionService

```python
import pytz
from datetime import datetime, date, timedelta

class CalendarSubscriptionService(SubscriptionService):
    """–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ v8.0"""
    
    def __init__(self):
        super().__init__()
        self.moscow_tz = pytz.timezone('Europe/Moscow')
    
    def _get_moscow_date(self) -> date:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ú–æ—Å–∫–≤–µ"""
        return datetime.now(self.moscow_tz).date()
    
    def _should_reset_calendar_limits(self, subscription: dict, moscow_date: date) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–µ–Ω –ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤"""
        last_reset = subscription.get('last_reset_date')
        if not last_reset:
            return True
            
        last_reset_date = datetime.fromisoformat(last_reset).date()
        plan_type = subscription['plan_type']
        
        if plan_type == 'premium':
            # PREMIUM: —Å–±—Ä–æ—Å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
            return moscow_date > last_reset_date
        else:
            # FREE: —Å–±—Ä–æ—Å –ø–µ—Ä–≤–æ–≥–æ —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞
            return (moscow_date.year > last_reset_date.year or 
                   moscow_date.month > last_reset_date.month)
    
    async def _reset_calendar_limits(self, user_id: int, plan_type: str, moscow_date: date):
        """–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–æ–≤"""
        next_reset = self._get_next_reset_date(plan_type, moscow_date)
        
        await self.supabase.table('subscriptions').update({
            'letters_used': 0,
            'last_reset_date': moscow_date.isoformat(),
            'period_start': moscow_date.isoformat(), 
            'period_end': next_reset.isoformat(),
            'updated_at': datetime.now().isoformat()
        }).eq('user_id', user_id).execute()
        
        logger.info(f"üìÖ Calendar reset for user {user_id}: {plan_type} -> next reset {next_reset}")
```

### –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞

```python
async def periodic_limits_reset():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é"""
    while True:
        try:
            moscow_time = datetime.now(pytz.timezone('Europe/Moscow'))
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –≤ —Ä–∞–π–æ–Ω–µ –ø–æ–ª—É–Ω–æ—á–∏
            if moscow_time.hour == 0 and moscow_time.minute < 10:
                await reset_all_calendar_limits()
                
            await asyncio.sleep(300)  # 5 –º–∏–Ω—É—Ç
        except Exception as e:
            logger.error(f"Error in periodic reset: {e}")
            await asyncio.sleep(300)

async def reset_all_calendar_limits():
    """–°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—é"""
    service = CalendarSubscriptionService()
    moscow_date = service._get_moscow_date()
    
    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Å–±—Ä–æ—Å–∞
    subscriptions = await service.get_subscriptions_for_reset(moscow_date)
    
    for sub in subscriptions:
        await service._reset_calendar_limits(sub['user_id'], sub['plan_type'], moscow_date)
```

---

## üöÄ –ü–õ–ê–ù –†–ï–õ–ò–ó–ê

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: HOTFIX (–°–ï–ì–û–î–ù–Ø)
1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É `Stanislav` —á–µ—Ä–µ–∑ SQL
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–¥–Ω–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –û–°–ù–û–í–ù–û–ô –†–ï–õ–ò–ó (2-3 –¥–Ω—è)
1. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—É—é –ª–æ–≥–∏–∫—É
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
3. ‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–õ–£–ß–®–ï–ù–ò–Ø UX (1 –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã `/limits` –∏ `/subscription`
2. ‚úÖ –£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ª–∏–º–∏—Ç–∞—Ö
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–±—Ä–æ—Å–µ

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –ì–û–¢–û–í–ù–û–°–¢–ò

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] PREMIUM –ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 –ú–°–ö
- [ ] FREE –ª–∏–º–∏—Ç—ã —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è 1 —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞ –≤ 00:00 –ú–°–ö  
- [ ] –§–æ–Ω–æ–≤—ã–π —Å–±—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–±—Ä–æ—Å–∞
- [ ] –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –º–æ—Å–∫–æ–≤—Å–∫–æ–º —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ unit-—Ç–µ—Å—Ç–∞–º–∏ 90%+
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ª–∏–º–∏—Ç–∞–º–∏
- [ ] Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –ë–î
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- [ ] –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ –ª–∏–º–∏—Ç—ã —Å–º–µ–Ω–æ–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
- [ ] –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üîç –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã:
```python
async def test_premium_daily_reset():
    """–¢–µ—Å—Ç —Å–±—Ä–æ—Å–∞ PREMIUM –ª–∏–º–∏—Ç–æ–≤ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"""
    service = CalendarSubscriptionService()
    
    # –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—á–µ—Ä–∞
    yesterday = service._get_moscow_date() - timedelta(days=1)
    subscription = create_test_subscription('premium', yesterday)
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–±—Ä–æ—Å –Ω—É–∂–µ–Ω
    should_reset = service._should_reset_calendar_limits(subscription, service._get_moscow_date())
    assert should_reset == True

async def test_free_monthly_reset():
    """–¢–µ—Å—Ç —Å–±—Ä–æ—Å–∞ FREE –ª–∏–º–∏—Ç–æ–≤ —Ä–∞–∑ –≤ –º–µ—Å—è—Ü"""
    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –º–µ—Å—è—á–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
    pass
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
- [ ] –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ ‚Üí –∞–≤—Ç–æ—Å–±—Ä–æ—Å
- [ ] –¢–µ—Å—Ç —Ä–∞–±–æ—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–∞—Ö
- [ ] –¢–µ—Å—Ç –Ω–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ —Å–±—Ä–æ—Å–∞

---

## üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö —Å–±—Ä–æ—Å–æ–≤ –ª–∏–º–∏—Ç–æ–≤ –≤ –¥–µ–Ω—å
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å–±—Ä–æ—Å–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ –ø–æ –¥–Ω—è–º

### –ê–ª–µ—Ä—Ç—ã:
- –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ —Å–±—Ä–æ—Å–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∞—Å—å
- –ë–æ–ª–µ–µ 5% –æ—à–∏–±–æ–∫ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ª–∏–º–∏—Ç–æ–≤
- –ê–Ω–æ–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤

---

## üéâ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã:

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã** - –≤—Å–µ–≥–¥–∞ –∑–Ω–∞—é—Ç –∫–æ–≥–¥–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø
2. **–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** - –≤—Å–µ PREMIUM –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ª–∏–º–∏—Ç—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã** - —Å–±—Ä–æ—Å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–∞–∂–µ –±–µ–∑ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è** - –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

---

## üö® –†–ò–°–ö–ò –ò –ú–ò–¢–ò–ì–ê–¶–ò–Ø

### –†–∏—Å–∫: –°–±–æ–π —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ —Å–±—Ä–æ—Å–∞
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –†–∏—Å–∫: –ü—Ä–æ–±–ª–µ–º—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ + —Ç–µ—Å—Ç—ã –≤ —Ä–∞–∑–Ω—ã—Ö –¢–ó

### –†–∏—Å–∫: Race conditions –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —Å–±—Ä–æ—Å–µ
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î + –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ + –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á

---

## üìû –ö–û–ù–¢–ê–ö–¢–´

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ —Ä–µ–ª–∏–∑**: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫  
**DevOps**: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫  

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞**: –°–µ–≥–æ–¥–Ω—è  
**–ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–π —Ä–µ–ª–∏–∑**: 3 –¥–Ω—è  
