# üöÄ –î–µ–ø–ª–æ–π v9.9: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ª–æ–≥–∏–∫–∏

**–î–∞—Ç–∞:** 2024-12-19  
**–í–µ—Ä—Å–∏—è:** v9.9  
**–¢–∏–ø:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è + SQL –º–∏–≥—Ä–∞—Ü–∏—è  

---

## **üìã –ß–¢–û –ò–°–ü–†–ê–í–õ–ï–ù–û**

### **üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç** –≤ `subscription_service.py` - —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –æ—à–∏–±–∫–∞ `ValueError`
2. **–ê—Ç–æ–º–∞—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞** - —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã race conditions –≤ `increment_usage`
3. **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ AI** - –º–µ–Ω—å—à–µ –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏** –≤ rate limiter - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∞ —É—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏

### **‚ö° –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:**
- SQL —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

---

## **üóÑÔ∏è –ú–ò–ì–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•**

**‚ùó –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:** –ù—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏—é

### **–®–∞–≥ 1: –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Supabase –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:
psql -h your-supabase-host -U postgres -d postgres -f migrations/v9.9_atomic_increment.sql
```

### **–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–ª–∞—Å—å
SELECT proname FROM pg_proc WHERE proname = 'increment_user_letters';

-- –¢–µ—Å—Ç–æ–≤—ã–π –≤—ã–∑–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç–µ 12345 –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π user_id)
SELECT * FROM increment_user_letters(12345);
```

---

## **üöÄ –ü–†–û–¶–ï–°–° –î–ï–ü–õ–û–Ø**

### **–í–∞—Ä–∏–∞–Ω—Ç 1: Railway (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
# 1. –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add .
git commit -m "v9.9: Fix critical logic issues and race conditions"

# 2. –ü—É—à –≤ main –≤–µ—Ç–∫—É
git push origin main

# 3. Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç
# –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ Railway Dashboard
```

### **–í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π**

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–æ—Ç
pm2 stop tg_soprovod

# 2. –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
git pull origin main

# 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
pip install -r requirements.txt

# 4. –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
# (—Å–º. —Ä–∞–∑–¥–µ–ª "–ú–ò–ì–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•")

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
pm2 start main.py --name tg_soprovod
```

---

## **üîç –ü–†–û–í–ï–†–ö–ê –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø**

### **1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
```bash
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å /start –±–æ—Ç—É
# –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å—á–µ—Ç—á–∏–∫ –ø–∏—Å–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### **2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
```bash
# –í Railway
tail -f logs

# –õ–æ–∫–∞–ª—å–Ω–æ
pm2 logs tg_soprovod

# –ò—Å–∫–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
# ‚úÖ Letter usage incremented atomically
# üßπ Auto-cleanup triggered
# ‚úÖ Limits result for user
```

### **3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏—é:**
```sql
-- –í Supabase SQL Editor
SELECT * FROM increment_user_letters(YOUR_TEST_USER_ID);
```

---

## **üìä –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **–ß—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞:**

1. **–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
   - `‚ùå Error parsing period_end date` - –¥–æ–ª–∂–Ω–æ –∏—Å—á–µ–∑–Ω—É—Ç—å
   - `‚ùå Error in atomic increment_usage` - –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–ª—è—Ç—å—Å—è
   - `üßπ Auto-cleanup triggered` - –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–ª—è—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 1000 –∑–∞–ø—Ä–æ—Å–æ–≤

2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   - –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –±–æ—Ç–∞
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:**
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–¥—Å—á–µ—Ç–∞ –ø–∏—Å–µ–º
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–∂–Ω—ã—Ö –æ—à–∏–±–æ–∫ AI
   - –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫

---

## **üÜò ROLLBACK –ü–õ–ê–ù**

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

### **1. –ë—ã—Å—Ç—Ä—ã–π rollback (Railway):**
```bash
# –í Railway Dashboard
# Deploy ‚Üí Previous Deployment ‚Üí Redeploy
```

### **2. –†—É—á–Ω–æ–π rollback:**
```bash
# –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥
git revert HEAD
git push origin main

# –£–¥–∞–ª–∏—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏—é (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
DROP FUNCTION IF EXISTS increment_user_letters(BIGINT);
```

### **3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É:**
```python
# –í subscription_service.py –≤—Ä–µ–º–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
period_end_date = datetime.fromisoformat(period_end.replace('Z', '+00:00')).date()
```

---

## **‚úÖ –ß–ï–ö–õ–ò–°–¢ –î–ï–ü–õ–û–Ø**

- [ ] –ö–æ–¥ –∑–∞–∫–æ–º–º–∏—á–µ–Ω –∏ –∑–∞–ø—É—à–µ–Ω
- [ ] SQL –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [ ] –§—É–Ω–∫—Ü–∏—è `increment_user_letters` —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ –æ—à–∏–±–∫–∏
- [ ] –°—á–µ—Ç—á–∏–∫ –ø–∏—Å–µ–º —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ rate limiter –∞–∫—Ç–∏–≤–Ω–∞

---

## **üìû –ü–û–î–î–ï–†–ñ–ö–ê**

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Railway/—Å–µ—Ä–≤–µ—Ä–∞
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Supabase
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π SQL –∑–∞–ø—Ä–æ—Å
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ - rollback

**–í—Ä–µ–º—è –¥–µ–ø–ª–æ—è:** ~15 –º–∏–Ω—É—Ç  
**Downtime:** ~2 –º–∏–Ω—É—Ç—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –¥–µ–ø–ª–æ–µ)  
**–†–∏—Å–∫:** –ù–∏–∑–∫–∏–π (—Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏—è, backward compatible) 