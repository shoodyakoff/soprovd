"""
–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä v3.0 - –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT –ø—Ä–æ–º–ø—Ç—ã
–ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ –±–µ–∑ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
"""
import json
import logging
from typing import Dict, Any, Optional

logger = logging.getLogger(__name__)


# ============ –ù–û–í–´–ï –ü–†–û–ú–ü–¢–´ –î–õ–Ø 4-–≠–¢–ê–ü–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ============

VACANCY_ANALYSIS_PROMPT = """
–ó–ê–î–ê–ß–ê: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å —Ä–µ–∑—é–º–µ.

–ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê –í–ê–ö–ê–ù–°–ò–ò:

1. –ñ–Å–°–¢–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (hard requirements):
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã (–≥–æ–¥—ã, —Å—Ñ–µ—Ä—ã)
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ/—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
   - –Ø–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è/–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

2. –ú–Ø–ì–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø (soft requirements):
   - –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–ø—ã—Ç
   - –õ–∏—á–Ω–æ—Å—Ç–Ω—ã–µ –∫–∞—á–µ—Å—Ç–≤–∞
   - –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ —Ä–∞–±–æ—Ç—ã

3. –ö–õ–Æ–ß–ï–í–´–ï –ë–ò–ó–ù–ï–°-–ó–ê–î–ê–ß–ò:
   - –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏
   - –ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Ä–µ—à–∞—Ç—å
   - –ö–∞–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–∂–∏–¥–∞—é—Ç—Å—è

4. –ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ü–ê–ù–ò–ò:
   - –†–∞–∑–º–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏/–∫–æ–º–∞–Ω–¥—ã
   - –û—Ç—Ä–∞—Å–ª—å –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
   - –≠—Ç–∞–ø —Ä–∞–∑–≤–∏—Ç–∏—è (—Å—Ç–∞—Ä—Ç–∞–ø/–∫–æ—Ä–ø–æ—Ä–∞—Ü–∏—è)
   - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞

5. –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê –ò –¢–ï–†–ú–ò–ù–´:
   - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
   - –û—Ç—Ä–∞—Å–ª–µ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
   - –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
   - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: JSON
{{
  "hard_requirements": [
    {{
      "requirement": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ",
      "importance": "critical/high/medium",
      "specificity": "specific/general",
      "keywords": ["–∫–ª—é—á–µ–≤—ã–µ", "—Å–ª–æ–≤–∞"]
    }}
  ],
  "soft_requirements": [...],
  "business_tasks": [...],
  "company_context": {{}},
  "key_terms": [...]
}}

–í–ê–ö–ê–ù–°–ò–Ø: {vacancy_text}
"""

RESUME_ANALYSIS_PROMPT = """
–ó–ê–î–ê–ß–ê: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤ –∏ –æ–ø—ã—Ç–∞ –∏–∑ —Ä–µ–∑—é–º–µ.

–ê–õ–ì–û–†–ò–¢–ú –ê–ù–ê–õ–ò–ó–ê –†–ï–ó–Æ–ú–ï:

1. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ù–ê–í–´–ö–ò:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
   - –£—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
   - –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

2. –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –û–ü–´–¢:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–æ–ª–∏ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏
   - –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å —Ü–∏—Ñ—Ä–∞–º–∏
   - –ü—Ä–æ–µ–∫—Ç—ã –∏ –∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
   - –ò–Ω–¥—É—Å—Ç—Ä–∏–∏ –∏ —Å—Ñ–µ—Ä—ã

3. –ë–ò–ó–ù–ï–°-–†–ï–ó–£–õ–¨–¢–ê–¢–´:
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ KPI
   - –£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
   - –†–µ—à—ë–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
   - –°–æ–∑–¥–∞–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å

4. –û–ë–†–ê–ó–û–í–ê–ù–ò–ï –ò –°–ï–†–¢–ò–§–ò–ö–ê–¢–´:
   - –§–æ—Ä–º–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
   - –ö—É—Ä—Å—ã –∏ —Ç—Ä–µ–Ω–∏–Ω–≥–∏

5. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò:
   - –í–æ–ª–æ–Ω—Ç—ë—Ä—Å—Ç–≤–æ
   - –ü—Ä–æ–µ–∫—Ç—ã –≤ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è
   - –ü—É–±–ª–∏–∫–∞—Ü–∏–∏/–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è
   - –•–æ–±–±–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —Ä–∞–±–æ—Ç–æ–π

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: JSON
{{
  "technical_skills": [
    {{
      "skill": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–≤—ã–∫",
      "level": "beginner/intermediate/advanced/expert",
      "context": "–≥–¥–µ –∏ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª",
      "results": "–∫–∞–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ—Å—Ç–∏–≥",
      "keywords": ["–∫–ª—é—á–µ–≤—ã–µ", "—Å–ª–æ–≤–∞"]
    }}
  ],
  "experience": [...],
  "achievements": [...],
  "education": [...],
  "additional": [...]
}}

–†–ï–ó–Æ–ú–ï: {resume_text}
"""

MATCHING_ANALYSIS_PROMPT = """
–ó–ê–î–ê–ß–ê: –ù–∞–π—Ç–∏ –¢–û–ß–ù–´–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –Ω–∞–≤—ã–∫–∞–º–∏ –≤ —Ä–µ–∑—é–º–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
1. –ò—â–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –∞ –Ω–µ –æ–±—â–∏–µ —Ç–µ–º—ã
2. –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–π –¢–û–ß–ù–´–ï —Ç–µ—Ä–º–∏–Ω—ã –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
3. –ù–µ –ø—É—Ç–∞–π —Å–º–µ–∂–Ω—ã–µ –æ—Ç—Ä–∞—Å–ª–∏ (PropTech ‚â† TravelTech)
4. –ö–∞–∂–¥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–û –∏–∑ —Ä–µ–∑—é–º–µ

–ê–õ–ì–û–†–ò–¢–ú –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø:

1. –ü–†–Ø–ú–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø (exact matches) - –û–î–ò–ù–ê–ö–û–í–´–ï —Ç–µ—Ä–º–∏–Ω—ã/–ø—Ä–æ—Ü–µ—Å—Å—ã:
   –ü—Ä–∏–º–µ—Ä—ã: "OKR" –≤ –≤–∞–∫–∞–Ω—Å–∏–∏ = "OKR" –≤ —Ä–µ–∑—é–º–µ
           "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–ª–æ–≥–æ–º" = "—Ä–∞–±–æ—Ç–∞ —Å –±—ç–∫–ª–æ–≥–æ–º"
           "UX-–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è" = "UX-—Ç–µ—Å—Ç—ã"
           "–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –∑–∞–¥–∞—á" = "–¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–∞ —ç—Ç–∞–ø—ã"

2. –°–ò–õ–¨–ù–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø (strong matches) - –°–ú–ï–ñ–ù–´–ï –Ω–∞–≤—ã–∫–∏ —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏:
   –ü—Ä–∏–º–µ—Ä—ã: "B2B –ø—Ä–æ–¥—É–∫—Ç—ã" ‚Üê "B2B-—Ä–µ—à–µ–Ω–∏–µ PRYSM"
           "–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ" ‚Üê "–¥–µ—Ä–µ–≤–æ –º–µ—Ç—Ä–∏–∫, NPV –∞–Ω–∞–ª–∏–∑"
           "–∑–∞–ø—É—Å–∫ –ø–æ–¥ –∫–ª—é—á" ‚Üê "–∑–∞–ø—É—Å—Ç–∏–ª MVP –∑–∞ 4 –º–µ—Å—è—Ü–∞"

3. –°–õ–ê–ë–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø (weak matches) - –û–ë–©–ò–ï –Ω–∞–≤—ã–∫–∏:
   –ü—Ä–∏–º–µ—Ä—ã: "–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è", "—Ä–∞–±–æ—Ç–∞ –≤ –∫–æ–º–∞–Ω–¥–µ"

4. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–ï–õ–´ (gaps) - –û–¢–°–£–¢–°–¢–í–£–Æ–©–ò–ï –∂–µ—Å—Ç–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
   –ü—Ä–∏–º–µ—Ä—ã: –ù–µ—Ç –æ–ø—ã—Ç–∞ –≤ TravelTech (–µ—Å—Ç—å —Ç–æ–ª—å–∫–æ PropTech)
           –ù–µ—Ç –ø—Ä—è–º–æ–≥–æ –æ–ø—ã—Ç–∞ –ê/–í —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

5. –ö–û–ú–ü–ï–ù–°–ò–†–£–Æ–©–ò–ï –§–ê–ö–¢–û–†–´:
   –ö–∞–∫ —Å–º–µ–∂–Ω—ã–π –æ–ø—ã—Ç –º–æ–∂–µ—Ç –ø–æ–∫—Ä—ã—Ç—å –ø—Ä–æ–±–µ–ª—ã

–ü–†–ê–í–ò–õ–ê –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–Ø:
- –ö–û–ù–ö–†–ï–¢–ù–û–°–¢–¨ > –æ–±—â–Ω–æ—Å—Ç—å: "OKR –∫–≤–∞—Ä—Ç–∞–ª—å–Ω—ã–µ" –ª—É—á—à–µ —á–µ–º "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
- –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê: –∫–∞–∂–¥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ–¥–∫—Ä–µ–ø–ª—è–π –§–ê–ö–¢–û–ú –∏–∑ —Ä–µ–∑—é–º–µ
- –ß–ï–°–¢–ù–û–°–¢–¨: –µ—Å–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ—Ç - –ø—Ä–∏–∑–Ω–∞–π –ø—Ä–æ–±–µ–ª, –Ω–æ –ø–æ–∫–∞–∂–∏ —Å–º–µ–∂–Ω—ã–π –æ–ø—ã—Ç
- –†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨: –ø–æ–∫–∞–∑—ã–≤–∞–π –ö–ê–ö –æ–ø—ã—Ç –ø—Ä–∏–º–µ–Ω–∏–º –∫ –Ω–æ–≤–æ–π —Ä–æ–ª–∏

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: JSON
{{
  "exact_matches": [
    {{
      "vacancy_requirement": "—Ç–æ—á–Ω–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏",
      "resume_match": "—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ä–µ–∑—é–º–µ", 
      "evidence": "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞/—Ñ–∞–∫—Ç –∏–∑ —Ä–µ–∑—é–º–µ",
      "relevance_score": 0.95,
      "bridge_explanation": "–∫–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –æ–ø—ã—Ç –ø—Ä–∏–º–µ–Ω–∏–º"
    }}
  ],
  "strong_matches": [
    {{
      "vacancy_requirement": "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ",
      "resume_match": "—Å–º–µ–∂–Ω—ã–π –æ–ø—ã—Ç",
      "evidence": "–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ",
      "relevance_score": 0.8,
      "bridge_explanation": "–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å"
    }}
  ],
  "weak_matches": [...],
  "critical_gaps": [
    {{
      "missing_requirement": "—á—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
      "compensating_factor": "—á—Ç–æ –º–æ–∂–µ—Ç –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å",
      "mitigation_strategy": "–∫–∞–∫ –ø–æ–¥–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–ø—ã—Ç–∞"
    }}
  ],
  "unique_advantages": [
    {{
      "advantage": "—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ",
      "value_to_employer": "—Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è"
    }}
  ]
}}

–ê–ù–ê–õ–ò–ó –í–ê–ö–ê–ù–°–ò–ò: {vacancy_analysis}
–ê–ù–ê–õ–ò–ó –†–ï–ó–Æ–ú–ï: {resume_analysis}
"""

LETTER_GENERATION_PROMPT = """
–ó–ê–î–ê–ß–ê: –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –∫–∞–∫ –°–í–Ø–ó–ù–£–Æ –ò–°–¢–û–†–ò–Æ, –∞ –Ω–µ —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤.

–£ —Ç–µ–±—è –µ—Å—Ç—å –¢–û–ß–ù–´–ô –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –º–µ–∂–¥—É –≤–∞–∫–∞–Ω—Å–∏–µ–π –∏ —Ä–µ–∑—é–º–µ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –¢–ï–ö–£–©–ò–• –ü–ò–°–ï–ú:
‚ùå "–£ –º–µ–Ω—è –µ—Å—Ç—å X. –¢–∞–∫–∂–µ —É –º–µ–Ω—è –µ—Å—Ç—å Y. –ö—Ä–æ–º–µ —Ç–æ–≥–æ, —è –¥–µ–ª–∞–ª Z."
‚úÖ "–ö–æ–≥–¥–∞ —è —Ä–∞–±–æ—Ç–∞–ª —Å X, —ç—Ç–æ –Ω–∞—É—á–∏–ª–æ –º–µ–Ω—è Y, —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ –¥–æ—Å—Ç–∏—á—å Z."

–ü–†–ò–ù–¶–ò–ü–´ –°–í–Ø–ó–ù–û–ô –ò–°–¢–û–†–ò–ò:
1. –õ–û–ì–ò–ß–ï–°–ö–ê–Ø –¶–ï–ü–û–ß–ö–ê: –∫–∞–∂–¥—ã–π –Ω–∞–≤—ã–∫/—Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã—Ç–µ–∫–∞–µ—Ç –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
2. –ü–†–ò–ß–ò–ù–ù–û-–°–õ–ï–î–°–¢–í–ï–ù–ù–´–ï –°–í–Ø–ó–ò: "–±–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É", "—ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ", "–ø–æ—ç—Ç–æ–º—É"
3. –ï–î–ò–ù–ê–Ø –ù–ê–†–†–ê–¢–ò–í–ê: –≤—Å–µ –æ–ø—ã—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –æ–¥–Ω—É –≥–ª–∞–≤–Ω—É—é –º—ã—Å–ª—å
4. –ü–†–û–ì–†–ï–°–°–ò–Ø: –æ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –∫ —Å–ª–æ–∂–Ω–æ–º—É, –ø–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–≤–∏—Ç–∏–µ

–°–í–Ø–ó–£–Æ–©–ò–ï –°–õ–û–í–ê –ò –ö–û–ù–°–¢–†–£–ö–¶–ò–ò:
- "–≠—Ç–æ –Ω–∞—É—á–∏–ª–æ –º–µ–Ω—è..."
- "–ë–ª–∞–≥–æ–¥–∞—Ä—è –æ–ø—ã—Ç—É –≤ X, —è —Å–º–æ–≥..."
- "–ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É..."
- "–†–∞–∑–≤–∏–≤–∞—è –Ω–∞–≤—ã–∫–∏ –≤ X, —è –ø–µ—Ä–µ—à–µ–ª –∫ Y..."
- "–≠—Ç–æ—Ç –æ–ø—ã—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª –º–µ–Ω—è –∫..."
- "–ö–æ–º–±–∏–Ω–∏—Ä—É—è X –∏ Y, —è –¥–æ—Å—Ç–∏–≥..."

–ê–õ–ì–û–†–ò–¢–ú –°–û–ó–î–ê–ù–ò–Ø –ò–°–¢–û–†–ò–ò:

1. –ù–ê–ô–î–ò –ì–õ–ê–í–ù–£–Æ –¢–ï–ú–£ (—Å–∫–≤–æ–∑–Ω—É—é –ª–∏–Ω–∏—é):
   –ß—Ç–æ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —Ç–≤–æ–∏ –Ω–∞–≤—ã–∫–∏? –ù–∞–ø—Ä–∏–º–µ—Ä:
   - "–°–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤–æ–º—É —Ä–∞–∑–≤–∏—Ç–∏—é"
   - "–≠–≤–æ–ª—é—Ü–∏—è –æ—Ç —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á –∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–º"
   - "–ü—É—Ç—å –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –∫ –∑–∞–ø—É—Å–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤"

2. –í–´–°–¢–†–û–ô –õ–û–ì–ò–ß–ï–°–ö–£–Æ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨:
   - –ß—Ç–æ –±—ã–ª–æ –û–°–ù–û–í–û–ô (—Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –Ω–∞–≤—ã–∫)
   - –ß—Ç–æ –†–ê–ó–í–ò–õ–û–°–¨ –∏–∑ —ç—Ç–æ–≥–æ (—Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å)  
   - –ö —á–µ–º—É —ç—Ç–æ –ü–†–ò–í–ï–õ–û (–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
   
   –ü—Ä–∏–º–µ—Ä: –ê–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ ‚Üí –ü–æ–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ ‚Üí –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π ‚Üí –ó–∞–ø—É—Å–∫ MVP

3. –°–û–ó–î–ê–ô –ü–†–ò–ß–ò–ù–ù–û-–°–õ–ï–î–°–¢–í–ï–ù–ù–´–ï –°–í–Ø–ó–ò:
   –í–º–µ—Å—Ç–æ: "–Ø —É–ø—Ä–∞–≤–ª—è–ª –±—ç–∫–ª–æ–≥–æ–º. –Ø –∑–∞–ø—É—Å—Ç–∏–ª MVP."
   –ü–∏—à–∏: "–£–ø—Ä–∞–≤–ª—è—è –±—ç–∫–ª–æ–≥–æ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ 20 —á–µ–ª–æ–≤–µ–∫, —è –Ω–∞—É—á–∏–ª—Å—è –≤–∏–¥–µ—Ç—å –ø—Ä–æ–¥—É–∫—Ç —Ü–µ–ª–∏–∫–æ–º, —á—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å MVP –∑–∞ 4 –º–µ—Å—è—Ü–∞."

4. –°–¢–†–£–ö–¢–£–†–ê –ü–ò–°–¨–ú–ê –° –õ–û–ì–ò–ö–û–ô:

   –ê–ë–ó–ê–¶ 1 - –ó–∞—Ü–µ–ø–∫–∞ + —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç (30-40 —Å–ª–æ–≤):
   "–í–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è –ø—Ä–∏–≤–ª–µ–∫–ª–∞ —Ç–µ–º, —á—Ç–æ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞]. –í [–∫–æ–º–ø–∞–Ω–∏–∏] —è –ø—Ä–æ—à–µ–ª –ø—É—Ç—å –æ—Ç [–Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞] –¥–æ [—Ä–µ–∑—É–ª—å—Ç–∞—Ç], —á—Ç–æ –¥–∞–ª–æ –º–Ω–µ [–∫–ª—é—á–µ–≤–æ–π –Ω–∞–≤—ã–∫]."

   –ê–ë–ó–ê–¶ 2 - –†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ (50-60 —Å–ª–æ–≤):
   "–ò–º–µ–Ω–Ω–æ [–±–∞–∑–æ–≤—ã–π –æ–ø—ã—Ç] –Ω–∞—É—á–∏–ª –º–µ–Ω—è [—Å–ª–µ–¥—É—é—â–∏–π –Ω–∞–≤—ã–∫]. –ë–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É —è —Å–º–æ–≥ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ], —á—Ç–æ –ø—Ä–∏–≤–µ–ª–æ –∫ [—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏]."

   –ê–ë–ó–ê–¶ 3 - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (40-50 —Å–ª–æ–≤):
   "–ö–æ–º–±–∏–Ω–∏—Ä—É—è [–Ω–∞–≤—ã–∫ 1] –∏ [–Ω–∞–≤—ã–∫ 2], —è [–∫–ª—é—á–µ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ]. –≠—Ç–æ—Ç –æ–ø—ã—Ç –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ [–∏–Ω—Å–∞–π—Ç/–ø–æ–Ω–∏–º–∞–Ω–∏–µ], –∏–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É [–∫–∞–∫ —ç—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–º–æ –∫ –Ω–æ–≤–æ–π —Ä–æ–ª–∏]."

   –ê–ë–ó–ê–¶ 4 - –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é (20-30 —Å–ª–æ–≤):
   "–ì–æ—Ç–æ–≤ –æ–±—Å—É–¥–∏—Ç—å, –∫–∞–∫ —ç—Ç–æ—Ç –æ–ø—ã—Ç –ø–æ–º–æ–∂–µ—Ç [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏]. –ö–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—å—Å—è?"

5. –ü–†–ò–ú–ï–†–´ –õ–û–ì–ò–ß–ï–°–ö–ò–• –°–í–Ø–ó–û–ö:

   –ü–õ–û–•–û: "–Ø —Ä–∞–±–æ—Ç–∞–ª —Å OKR. –Ø —É–ø—Ä–∞–≤–ª—è–ª –±—ç–∫–ª–æ–≥–æ–º. –Ø –∑–∞–ø—É—Å—Ç–∏–ª MVP."
   
   –•–û–†–û–®–û: "–í–Ω–µ–¥—Ä—è—è OKR –≤ –∫–æ–º–∞–Ω–¥–µ, —è –ø–æ–Ω—è–ª –≤–∞–∂–Ω–æ—Å—Ç—å —á–µ—Ç–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ –ø–æ–º–æ–≥–ª–æ –º–Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—ç–∫–ª–æ–≥–æ–º —Ç–∞–∫, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –∏–∑ 20 —á–µ–ª–æ–≤–µ–∫ —Ä–∞–±–æ—Ç–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ–∑–≤–æ–ª–∏–ª –∑–∞–ø—É—Å—Ç–∏—Ç—å MVP –≤—Å–µ–≥–æ –∑–∞ 4 –º–µ—Å—è—Ü–∞."

6. –ü–†–û–í–ï–†–ö–ê –°–í–Ø–ó–ù–û–°–¢–ò:
   - –ú–æ–∂–Ω–æ –ª–∏ —É–±—Ä–∞—Ç—å –ª—é–±–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Å–º—ã—Å–ª–∞? (‚ùå –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ù–ï–¢)
   - –ï—Å—Ç—å –ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é? (‚úÖ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –î–ê)
   - –ü–æ–Ω—è—Ç–Ω–æ –ª–∏, –ö–ê–ö –∫–∞–∂–¥—ã–π –æ–ø—ã—Ç –ø–æ–≤–ª–∏—è–ª –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π? (‚úÖ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –î–ê)

–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
{matching_analysis}

–ü–†–ò–ú–ï–† –°–í–Ø–ó–ù–û–ô –ò–°–¢–û–†–ò–ò:
"–†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ –≤ –±–∞–Ω–∫–µ –Ω–∞—É—á–∏–ª–∞ –º–µ–Ω—è –≤–∏–¥–µ—Ç—å –≤–ª–∏—è–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –±–∏–∑–Ω–µ—Å. –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ—à–µ–ª –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–æ–º–∞–Ω–¥–æ–π, —è —Å–º–æ–≥ –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã —Ç–∞–∫, —á—Ç–æ –º—ã —É–ª—É—á—à–∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ 15%. –≠—Ç–æ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –ø—Ä–æ–¥—É–∫—Ç—É –ø–æ–º–æ–≥ –∑–∞–ø—É—Å—Ç–∏—Ç—å MVP –∑–∞ —Ä–µ–∫–æ—Ä–¥–Ω—ã–µ 4 –º–µ—Å—è—Ü–∞ - –∫–æ–º–∞–Ω–¥–∞ –ø–æ–Ω–∏–º–∞–ª–∞, –∫ –∫–∞–∫–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É –º—ã –∏–¥–µ–º."

–ù–∞–ø–∏—à–∏ –°–í–Ø–ó–ù–£–Æ –ò–°–¢–û–†–ò–Æ, –∞ –Ω–µ —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤. –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –õ–û–ì–ò–ß–ï–°–ö–ò –≤—ã—Ç–µ–∫–∞—Ç—å –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ.
"""

# ============ –°–¢–ê–†–´–ï –ü–†–û–ú–ü–¢–´ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) ============

DEEP_ANALYSIS_PROMPT = """–¢—ã —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –ø–æ HR –∏ —Ä–µ–∫—Ä—É—Ç–∏–Ω–≥—É. –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Ä–µ–∑—é–º–µ.

–ó–ê–î–ê–ß–ê: –ü–æ—à–∞–≥–æ–≤–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –≤–µ—Ä–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON

–≠–¢–ê–ü–´ –ê–ù–ê–õ–ò–ó–ê:

1. –ê–ù–ê–õ–ò–ó –í–ê–ö–ê–ù–°–ò–ò - –∏—â–∏ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
   - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (Python, React, Figma, Tableau, etc.)
   - –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ (Scrum, Agile, Design Thinking, OKR, etc.)
   - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ (A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, SQL, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥, etc.)
   - –û—Ç—Ä–∞—Å–ª–∏ –∏ –ø—Ä–æ–¥—É–∫—Ç—ã (fintech, e-commerce, SaaS, etc.)
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–æ–ø—ã—Ç X –ª–µ—Ç, –∫–æ–º–∞–Ω–¥–∞ Y —á–µ–ª–æ–≤–µ–∫)

2. –ê–ù–ê–õ–ò–ó –†–ï–ó–Æ–ú–ï - –∏—â–∏ –¢–û–ß–ù–´–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è:
   - –¢–µ –∂–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
   - –¢–µ –∂–µ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –∏ –ø—Ä–æ—Ü–µ—Å—Å—ã  
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å —Ü–∏—Ñ—Ä–∞–º–∏
   - –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ—Ç—Ä–∞—Å–ª–µ–≤–æ–π –æ–ø—ã—Ç
   - –°—Ö–æ–∂–∏–µ –ø—Ä–æ–µ–∫—Ç–Ω—ã–µ —Ä–æ–ª–∏

3. –ü–û–ò–°–ö –ü–†–Ø–ú–´–• –°–û–í–ü–ê–î–ï–ù–ò–ô:
   - –°–æ–ø–æ—Å—Ç–∞–≤—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ 1:1 —Å –æ–ø—ã—Ç–æ–º
   - –ò–≥–Ω–æ—Ä–∏—Ä—É–π –æ–±—â–∏–µ –Ω–∞–≤—ã–∫–∏ (–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å)
   - –§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö
   - –ù–∞–π–¥–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è (—Ä–µ–¥–∫–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –Ω–∏—à–µ–≤—ã–π –æ–ø—ã—Ç)
   - –í—ã—è–≤–∏ —Å–∞–º—ã–µ —Å–∏–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê: —Å—Ç—Ä–æ–≥–æ JSON –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
{{
  "vacancy_analysis": {{
    "key_requirements": ["—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ1", "—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ2"],
    "pain_points": ["–ø—Ä–æ–±–ª–µ–º–∞1", "–ø—Ä–æ–±–ª–µ–º–∞2"], 
    "priorities": ["–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç1", "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç2"],
    "company_culture": "–æ–ø–∏—Å–∞–Ω–∏–µ –∫—É–ª—å—Ç—É—Ä—ã",
    "urgency_signals": ["—Å–∏–≥–Ω–∞–ª1", "—Å–∏–≥–Ω–∞–ª2"],
    "hidden_needs": ["—Å–∫—Ä—ã—Ç–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å1", "—Å–∫—Ä—ã—Ç–∞—è –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å2"]
  }},
  "resume_analysis": {{
    "key_skills": ["–Ω–∞–≤—ã–∫1", "–Ω–∞–≤—ã–∫2"],
    "achievements": ["–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏1", "–¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏2"],
    "unique_advantages": ["–£–¢–ü1", "–£–¢–ü2"],
    "career_trajectory": "–æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ –ø—É—Ç–∏",
    "transferable_skills": ["–ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–π –Ω–∞–≤—ã–∫1", "–ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–π –Ω–∞–≤—ã–∫2"]
  }},
  "matching_strategy": {{
    "direct_matches": ["—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ1", "—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ2"],
    "skill_gaps": ["–ø—Ä–æ–±–µ–ª1", "–ø—Ä–æ–±–µ–ª2"],
    "positioning": "—Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
    "value_proposition": "—Ü–µ–Ω–Ω–æ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
    "specific_references": ["–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ—Ç—Å—ã–ª–∫–∞ –∫ –≤–∞–∫–∞–Ω—Å–∏–∏1", "–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –æ—Ç—Å—ã–ª–∫–∞ –∫ –≤–∞–∫–∞–Ω—Å–∏–∏2"]
  }},
  "confidence_score": 0.85
}}

–í–ê–ö–ê–ù–°–ò–Ø:
{vacancy_text}

–†–ï–ó–Æ–ú–ï:
{resume_text}"""


HUMAN_WRITING_PROMPT = """–¢—ã –ø–∏—à–µ—à—å —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∏—Å—å–º–∞ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –Ω–∞ —Ä–∞–±–æ—Ç—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ, –∫–æ—Ç–æ—Ä–æ–µ —Ü–µ–ø–ª—è–µ—Ç HR –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –º–µ–∂–¥—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∏ –æ–ø—ã—Ç–æ–º.

–ê–ù–ê–õ–ò–ó –ò–ó –ü–†–ï–î–´–î–£–©–ï–ì–û –≠–¢–ê–ü–ê:
{analysis_json}

–≠–¢–ê–ü 1: –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
‚Ä¢ –í—ã–ø–∏—à–∏ 5-7 –∫–ª—é—á–µ–≤—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏
‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–∏ –ö–û–ù–ö–†–ï–¢–ù–û–ï —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ä–µ–∑—é–º–µ (–Ω–µ –æ–±—â–∏–µ —Å–ª–æ–≤–∞, –∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞–≤—ã–∫–∏/–æ–ø—ã—Ç/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
‚Ä¢ –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å—Ç–∏ —ç—Ç–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ

–≠–¢–ê–ü 2: –°–æ–∑–¥–∞–π "–º–æ—Å—Ç—ã" –º–µ–∂–¥—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –∏ –æ–ø—ã—Ç–æ–º
–§–æ—Ä–º–∞—Ç: "–í–∞–º –≤–∞–∂–Ω–æ X ‚Üí –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ Y"

–ü—Ä–∏–º–µ—Ä—ã –ü–†–ê–í–ò–õ–¨–ù–´–• —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:
‚Ä¢ "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ Scrum" ‚Üí "3 –≥–æ–¥–∞ —Ä–∞–±–æ—Ç—ã —Å–æ Scrum –≤ –∫–æ–º–∞–Ω–¥–µ –∏–∑ 15 —á–µ–ª–æ–≤–µ–∫"
‚Ä¢ "–∞–Ω–∞–ª–∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è" ‚Üí "–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Google Analytics –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ A/B —Ç–µ—Å—Ç–æ–≤"
‚Ä¢ "—Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö MySQL" ‚Üí "–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ MySQL, —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –Ω–∞ 40%"
‚Ä¢ "OKR –∏ —Ü–µ–ª–µ–ø–æ–ª–∞–≥–∞–Ω–∏–µ" ‚Üí "–≤–Ω–µ–¥—Ä–∏–ª —Å–∏—Å—Ç–µ–º—É OKR –≤ –∫–æ–º–∞–Ω–¥–µ –∏–∑ 12 —á–µ–ª–æ–≤–µ–∫, –¥–æ—Å—Ç–∏–≥–ª–∏ 95% —Ü–µ–ª–µ–π"
‚Ä¢ "—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" ‚Üí "—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª 3-–ª–µ—Ç–Ω—é—é –ø—Ä–æ–¥—É–∫—Ç–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, —É–≤–µ–ª–∏—á–∏–≤—à—É—é DAU –Ω–∞ 150%"

–ü—Ä–∏–º–µ—Ä—ã –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:
‚Ä¢ "–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏" ‚Üí "—Ä–∞–±–æ—Ç–∞–ª –≤ –∫–æ–º–∞–Ω–¥–µ" (—Å–ª–∏—à–∫–æ–º –æ–±—â–µ–µ)
‚Ä¢ "–æ–ø—ã—Ç –ø—Ä–æ–¥–∞–∂" ‚Üí "—É–≤–µ–ª–∏—á–∏–ª –≤—ã—Ä—É—á–∫—É" (–Ω–µ—Ç –ø—Ä—è–º–æ–π —Å–≤—è–∑–∏ —Å –ø—Ä–æ–¥–∞–∂–∞–º–∏)

–≠–¢–ê–ü 3: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∏—Å—å–º–∞

–ê–±–∑–∞—Ü 1: –ú–æ—Ç–∏–≤–∞—Ü–∏—è/–∑–∞—Ü–µ–ø–∫–∞
‚Ä¢ –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ –∫–æ–º–ø–∞–Ω–∏—è/–ø—Ä–æ–¥—É–∫—Ç –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç
‚Ä¢ –ú–æ–∂–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—å 1 —Å–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ

–ê–±–∑–∞—Ü 2: –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
‚Ä¢ 2-3 —Å–∞–º—ã—Ö —Å–∏–ª—å–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
‚Ä¢ –ö–∞–∂–¥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ = —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ + —Ç–≤–æ–π –æ–ø—ã—Ç + —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å —Ü–∏—Ñ—Ä–∞–º–∏

–ê–±–∑–∞—Ü 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞
‚Ä¢ –ï—â–µ 2-3 —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–µ –≥–ª—É–±–∏–Ω—É –∑–Ω–∞–Ω–∏–π
‚Ä¢ –ú–µ–Ω–µ–µ –æ—á–µ–≤–∏–¥–Ω—ã–µ, –Ω–æ –≤–∞–∂–Ω—ã–µ –Ω–∞–≤—ã–∫–∏

–ê–±–∑–∞—Ü 4: –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏/–∑–≤–æ–Ω–∫–∞
‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏

–ü–†–ê–í–ò–õ–ê:
‚Ä¢ –£–±–µ—Ä–∏ –≤–æ–¥—É –∏ –∫–ª–∏—à–µ ("—Å –ø–æ–ª–Ω–æ–π –æ—Ç–¥–∞—á–µ–π", "—ç—Ç–æ —Ç–æ —á—Ç–æ –∏—Å–∫–∞–ª")
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 4 –∞–±–∑–∞—Ü–∞
‚Ä¢ –¢–æ–Ω - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –∂–∏–≤–æ–π
‚Ä¢ –°–¢–ò–õ–¨: {writing_style}

–¢–µ–ø–µ—Ä—å –Ω–∞–ø–∏—à–∏ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Ä–µ–∑—é–º–µ.
–ù–∞–ø–∏—à–∏ –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤."""


DEAI_PROMPT = """–ü—Ä–æ–≤–µ—Ä—å —Ç–µ–∫—Å—Ç –Ω–∞ –ò–ò-—à—Ç–∞–º–ø—ã –∏ —Å–¥–µ–ª–∞–π –µ–≥–æ –±–æ–ª–µ–µ —á–µ–ª–æ–≤–µ—á–Ω—ã–º.

–î–ï–¢–ï–ö–¢–ò–†–£–ï–ú–´–ï –ü–ê–¢–¢–ï–†–ù–´:
- "—Ö–æ—Ç–µ–ª –±—ã –≤—ã—Ä–∞–∑–∏—Ç—å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å" 
- "—Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –º–æ—é –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä—É"
- "–∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–∂—É –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏"
- "—É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∫–æ–º–±–∏–Ω–∞—Ü–∏—è –Ω–∞–≤—ã–∫–æ–≤"
- "–≥–æ—Ç–æ–≤ –≤–Ω–µ—Å—Ç–∏ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥"
- "–±—É–¥—É —Ä–∞–¥ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–±—Å—É–¥–∏—Ç—å"
- "—Å –Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ–º –∂–¥—É –≤–∞—à–µ–≥–æ –æ—Ç–≤–µ—Ç–∞"
- "—Å—Ç—Ä–∞—Å—Ç–Ω–æ —É–≤–ª–µ—á–µ–Ω"
- "—Ç–∞–∫–∂–µ —Å—Ç–æ–∏—Ç —É–ø–æ–º—è–Ω—É—Ç—å"
- "–∫—Ä–æ–º–µ —Ç–æ–≥–æ, —Ö–æ—á—É –æ—Ç–º–µ—Ç–∏—Ç—å"

–ó–ê–ú–ï–ù–ò –ù–ê –ß–ï–õ–û–í–ï–ß–ù–´–ï –í–ê–†–ò–ê–ù–¢–´:
- "–∑–∞–º–µ—Ç–∏–ª –≤–∞—à—É –≤–∞–∫–∞–Ω—Å–∏—é –∏ –ø–æ–Ω—è–ª - —ç—Ç–æ —Ç–æ, —á—Ç–æ –∏—Å–∫–∞–ª"
- "–≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–ª–µ–∫–ª–æ –≤–Ω–∏–º–∞–Ω–∏–µ"
- "–¥—É–º–∞—é, –º–æ–π –æ–ø—ã—Ç –∑–¥–µ—Å—å –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è"
- "–≤ [–∫–æ–º–ø–∞–Ω–∏—è] –º–Ω–µ –¥–æ–≤–µ–ª–æ—Å—å"
- "–∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–ª –Ω–∞–¥ [–ø—Ä–æ–µ–∫—Ç], —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å"
- "–∑–∞ X –ª–µ—Ç —Ä–∞–±–æ—Ç—ã –≤ [—Å—Ñ–µ—Ä–∞] –Ω–∞—É—á–∏–ª—Å—è"

–ü–†–ê–í–ò–õ–ê –£–õ–£–ß–®–ï–ù–ò–Ø:
1. –£–±–µ—Ä–∏ –≤—Å–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
2. –î–æ–±–∞–≤—å –∂–∏–≤—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
3. –ó–∞–º–µ–Ω–∏ –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
4. –°–¥–µ–ª–∞–π –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏
5. –î–æ–±–∞–≤—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é —Å–æ—Å—Ç–∞–≤–ª—è—é—â—É—é, –Ω–æ –±–µ–∑ –ø–∞—Ñ–æ—Å–∞

–¢–ï–ö–°–¢ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò:
{text}

–í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ø–æ–º–µ—Ç–æ–∫."""


# ============ –û–°–ù–û–í–ù–û–ô –ö–õ–ê–°–° ============

class SmartAnalyzer:
    """–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –Ω–∞ –æ—Å–Ω–æ–≤–µ GPT –ø—Ä–æ–º–ø—Ç–æ–≤"""
    
    def __init__(self, openai_service):
        self.openai = openai_service
        
    async def deep_analyze(self, vacancy_text: str, resume_text: str) -> Dict[str, Any]:
        """
        –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT
        
        Args:
            vacancy_text: –¢–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏
            resume_text: –¢–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ
            
        Returns:
            Dict —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        logger.info("üîç –ù–∞—á–∏–Ω–∞—é –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT...")
        
        prompt = DEEP_ANALYSIS_PROMPT.format(
            vacancy_text=vacancy_text,
            resume_text=resume_text
        )
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.3,  # –î–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                max_tokens=2000
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GPT")
                return self._get_fallback_analysis()
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç markdown –±–ª–æ–∫–æ–≤
            cleaned_response = response.strip()
            if cleaned_response.startswith('```json'):
                cleaned_response = cleaned_response[7:]  # —É–±–∏—Ä–∞–µ–º ```json
            if cleaned_response.endswith('```'):
                cleaned_response = cleaned_response[:-3]  # —É–±–∏—Ä–∞–µ–º ```
            cleaned_response = cleaned_response.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON
            analysis = json.loads(cleaned_response)
            logger.info(f"‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {analysis.get('confidence_score', 0):.2f}")
            
            return analysis
            
        except json.JSONDecodeError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
            logger.error(f"–û—Ç–≤–µ—Ç GPT: {response}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            return self._get_fallback_analysis()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}")
            logger.error(f"üîç –ö–æ–Ω—Ç–µ–∫—Å—Ç: –≤–∞–∫–∞–Ω—Å–∏—è={len(vacancy_text)} —Å–∏–º–≤–æ–ª–æ–≤, —Ä–µ–∑—é–º–µ={len(resume_text)} —Å–∏–º–≤–æ–ª–æ–≤")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –≤–º–µ—Å—Ç–æ raise –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            logger.warning("üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ fallback –∞–Ω–∞–ª–∏–∑...")
            return self._get_fallback_analysis()
    
    async def generate_human_letter(
        self, 
        analysis: Dict[str, Any], 
        style: str = "professional"
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ–ª–æ–≤–µ—á–Ω–æ–≥–æ –ø–∏—Å—å–º–∞
        
        Args:
            analysis: –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            style: –°—Ç–∏–ª—å –ø–∏—Å—å–º–∞
            
        Returns:
            –ì–æ—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ
        """
        logger.info("‚úçÔ∏è –ì–µ–Ω–µ—Ä–∏—Ä—É—é —á–µ–ª–æ–≤–µ—á–Ω–æ–µ –ø–∏—Å—å–º–æ...")
        
        prompt = HUMAN_WRITING_PROMPT.format(
            analysis_json=json.dumps(analysis, ensure_ascii=False, indent=2),
            writing_style=style
        )
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.7,  # –î–ª—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
                max_tokens=1500
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞")
                raise Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GPT")
            
            logger.info("‚úÖ –ü–∏—Å—å–º–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ")
            return response.strip()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞: {e}")
            raise
    
    async def deai_text(self, text: str) -> str:
        """
        –î–µ–ò–ò-—Ñ–∏–∫–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ - —É–±–∏—Ä–∞–µ–º –ò–ò-—à—Ç–∞–º–ø—ã
        
        Args:
            text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
            
        Returns:
            –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ—á–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        logger.info("üîß –ü—Ä–∏–º–µ–Ω—è—é –¥–µ–ò–ò-—Ñ–∏–∫–∞—Ü–∏—é...")
        
        prompt = DEAI_PROMPT.format(text=text)
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.5,
                max_tokens=1500
            )
            
            if not response:
                logger.warning("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –¥–µ–ò–ò-—Ñ–∏–∫–∞—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç")
                return text
            
            logger.info("‚úÖ –î–µ–ò–ò-—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
            return response.strip()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –¥–µ–ò–ò-—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
            return text
    
    async def generate_full_analysis_and_letter(
        self,
        vacancy_text: str,
        resume_text: str,
        style: str = "professional"
    ) -> Dict[str, str]:
        """
        –ù–æ–≤—ã–π 4-—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞
        
        Args:
            vacancy_text: –¢–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏
            resume_text: –¢–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ
            style: –°—Ç–∏–ª—å –ø–∏—Å—å–º–∞
            
        Returns:
            Dict —Å –ø–∏—Å—å–º–æ–º –∏ –∞–Ω–∞–ª–∏–∑–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        """
        logger.info("üöÄ –ó–∞–ø—É—Å–∫–∞—é –Ω–æ–≤—ã–π 4-—ç—Ç–∞–ø–Ω—ã–π —Ñ–ª–æ—É...")
        logger.info(f"üìä –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: –≤–∞–∫–∞–Ω—Å–∏—è={len(vacancy_text)} —Å–∏–º–≤–æ–ª–æ–≤, —Ä–µ–∑—é–º–µ={len(resume_text)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –≠–¢–ê–ü 1: –ê–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏
        logger.info("üîç –≠–¢–ê–ü 1: –ê–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏...")
        vacancy_analysis = await self.analyze_vacancy_structured(vacancy_text)
        logger.info("‚úÖ –≠–¢–ê–ü 1 –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # –≠–¢–ê–ü 2: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ  
        logger.info("üë§ –≠–¢–ê–ü 2: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ...")
        resume_analysis = await self.analyze_resume_structured(resume_text)
        logger.info("‚úÖ –≠–¢–ê–ü 2 –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # –≠–¢–ê–ü 3: –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        logger.info("‚ö° –≠–¢–ê–ü 3: –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π...")
        matching_analysis = await self.detailed_matching_analysis(
            vacancy_analysis, resume_analysis
        )
        logger.info("‚úÖ –≠–¢–ê–ü 3 –∑–∞–≤–µ—Ä—à–µ–Ω")
        
        # –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞
        logger.info("‚úçÔ∏è –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞...")
        letter = await self.generate_letter_from_analysis(matching_analysis)
        logger.info(f"‚úÖ –≠–¢–ê–ü 4 –∑–∞–≤–µ—Ä—à–µ–Ω. –î–ª–∏–Ω–∞ –ø–∏—Å—å–º–∞: {len(letter)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –≠–¢–ê–ü 5: –î–µ-–ò–ò-—Ñ–∏–∫–∞—Ü–∏—è
        logger.info("üîß –≠–¢–ê–ü 5: –î–µ-–ò–ò-—Ñ–∏–∫–∞—Ü–∏—è...")
        final_letter = await self.deai_text(letter)
        logger.info(f"‚úÖ –≠–¢–ê–ü 5 –∑–∞–≤–µ—Ä—à–µ–Ω. –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: {len(final_letter)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        formatted_analysis = self.format_matching_summary(matching_analysis)
        
        logger.info("üéâ –ù–æ–≤—ã–π 4-—ç—Ç–∞–ø–Ω—ã–π —Ñ–ª–æ—É –∑–∞–≤–µ—Ä—à–µ–Ω!")
        return {
            'letter': final_letter,
            'analysis': formatted_analysis
        }
    
    async def analyze_vacancy_structured(self, vacancy_text: str) -> Dict[str, Any]:
        """
        –≠–¢–ê–ü 1: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏
        """
        prompt = VACANCY_ANALYSIS_PROMPT.format(vacancy_text=vacancy_text)
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.3,  # –î–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                max_tokens=2000
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –≤–∞–∫–∞–Ω—Å–∏–∏")
                return self._get_fallback_vacancy_analysis()
            
            # –ü–∞—Ä—Å–∏–º JSON
            return self._parse_json_safely(response, "vacancy_analysis")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞–∫–∞–Ω—Å–∏–∏: {e}")
            return self._get_fallback_vacancy_analysis()
    
    async def analyze_resume_structured(self, resume_text: str) -> Dict[str, Any]:
        """
        –≠–¢–ê–ü 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ
        """
        prompt = RESUME_ANALYSIS_PROMPT.format(resume_text=resume_text)
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.3,
                max_tokens=2000
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∑—é–º–µ")
                return self._get_fallback_resume_analysis()
            
            return self._parse_json_safely(response, "resume_analysis")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—é–º–µ: {e}")
            return self._get_fallback_resume_analysis()
    
    async def detailed_matching_analysis(
        self, 
        vacancy_analysis: Dict[str, Any], 
        resume_analysis: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        –≠–¢–ê–ü 3: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        """
        prompt = MATCHING_ANALYSIS_PROMPT.format(
            vacancy_analysis=json.dumps(vacancy_analysis, ensure_ascii=False, indent=2),
            resume_analysis=json.dumps(resume_analysis, ensure_ascii=False, indent=2)
        )
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.4,
                max_tokens=2000
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π")
                return self._get_fallback_matching_analysis()
            
            return self._parse_json_safely(response, "matching_analysis")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: {e}")
            return self._get_fallback_matching_analysis()
    
    async def generate_letter_from_analysis(self, matching_analysis: Dict[str, Any]) -> str:
        """
        –≠–¢–ê–ü 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
        """
        prompt = LETTER_GENERATION_PROMPT.format(
            matching_analysis=json.dumps(matching_analysis, ensure_ascii=False, indent=2)
        )
        
        try:
            response = await self.openai.get_completion(
                prompt=prompt,
                temperature=0.7,  # –î–ª—è –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
                max_tokens=1500
            )
            
            if not response:
                logger.error("‚ùå –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞")
                raise Exception("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç GPT")
            
            return response.strip()
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–∏—Å—å–º–∞: {e}")
            raise
    
    def format_matching_summary(self, matching_analysis: Dict[str, Any]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        try:
            summary = "üìä –ê–ù–ê–õ–ò–ó –°–û–í–ü–ê–î–ï–ù–ò–ô –í–ê–ö–ê–ù–°–ò–ò –ò –†–ï–ó–Æ–ú–ï\n\n"
            
            # –ü—Ä—è–º—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            exact_matches = matching_analysis.get('exact_matches', [])
            if exact_matches:
                summary += "‚úÖ –ü–†–Ø–ú–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø:\n"
                for match in exact_matches[:5]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ø-5
                    req = match.get('vacancy_requirement', '–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ')
                    evidence = match.get('evidence', '–û–ø—ã—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω')
                    summary += f"‚Ä¢ {req} ‚Üí {evidence}\n"
                summary += "\n"
            
            # –°–∏–ª—å–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
            strong_matches = matching_analysis.get('strong_matches', [])
            if strong_matches:
                summary += "‚ö° –°–ò–õ–¨–ù–´–ï –°–û–í–ü–ê–î–ï–ù–ò–Ø:\n"
                for match in strong_matches[:3]:
                    req = match.get('vacancy_requirement', '–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ')
                    evidence = match.get('evidence', '–°–º–µ–∂–Ω—ã–π –æ–ø—ã—Ç')
                    summary += f"‚Ä¢ {req} ‚Üí {evidence}\n"
                summary += "\n"
            
            # –ü—Ä–æ–±–µ–ª—ã
            gaps = matching_analysis.get('critical_gaps', [])
            if gaps:
                summary += "‚ö†Ô∏è –û–ë–õ–ê–°–¢–ò –î–õ–Ø –†–ê–ó–í–ò–¢–ò–Ø:\n"
                for gap in gaps[:3]:
                    if isinstance(gap, str):
                        summary += f"‚Ä¢ {gap}\n"
                    elif isinstance(gap, dict):
                        summary += f"‚Ä¢ {gap.get('missing_requirement', '–ü—Ä–æ–±–µ–ª –≤ –Ω–∞–≤—ã–∫–∞—Ö')}\n"
                summary += "\n"
            
            # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
            advantages = matching_analysis.get('unique_advantages', [])
            if advantages:
                summary += "üéØ –£–ù–ò–ö–ê–õ–¨–ù–´–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:\n"
                for advantage in advantages[:3]:
                    if isinstance(advantage, str):
                        summary += f"‚Ä¢ {advantage}\n"
                    elif isinstance(advantage, dict):
                        summary += f"‚Ä¢ {advantage.get('advantage', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å')}\n"
            
            return summary
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞: {e}")
            return "üìä –ê–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."

    async def generate_full_letter(
        self,
        vacancy_text: str,
        resume_text: str,
        style: str = "professional"
    ) -> str:
        """
        –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ - –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        """
        logger.info("üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ generate_full_letter –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏")
        result = await self.generate_full_analysis_and_letter(vacancy_text, resume_text, style)
        return result['letter']
    
    def _parse_json_safely(self, response: str, analysis_type: str) -> Dict[str, Any]:
        """–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞ –æ—Ç GPT"""
        try:
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç markdown –±–ª–æ–∫–æ–≤
            cleaned_response = response.strip()
            if cleaned_response.startswith('```json'):
                cleaned_response = cleaned_response[7:]  # —É–±–∏—Ä–∞–µ–º ```json
            if cleaned_response.endswith('```'):
                cleaned_response = cleaned_response[:-3]  # —É–±–∏—Ä–∞–µ–º ```
            cleaned_response = cleaned_response.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON
            parsed = json.loads(cleaned_response)
            logger.info(f"‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω –¥–ª—è {analysis_type}")
            return parsed
            
        except json.JSONDecodeError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –¥–ª—è {analysis_type}: {e}")
            logger.error(f"–û—Ç–≤–µ—Ç GPT: {response[:500]}...")
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
            if analysis_type == "vacancy_analysis":
                return self._get_fallback_vacancy_analysis()
            elif analysis_type == "resume_analysis":
                return self._get_fallback_resume_analysis()
            elif analysis_type == "matching_analysis":
                return self._get_fallback_matching_analysis()
            else:
                return self._get_fallback_analysis()
    
    def _get_fallback_vacancy_analysis(self) -> Dict[str, Any]:
        """Fallback –∞–Ω–∞–ª–∏–∑ –≤–∞–∫–∞–Ω—Å–∏–∏"""
        return {
            "hard_requirements": [
                {
                    "requirement": "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç",
                    "importance": "high",
                    "specificity": "general",
                    "keywords": ["–æ–ø—ã—Ç", "–Ω–∞–≤—ã–∫–∏"]
                }
            ],
            "soft_requirements": [
                {
                    "requirement": "–∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏",
                    "importance": "medium",
                    "specificity": "general",
                    "keywords": ["–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è"]
                }
            ],
            "business_tasks": ["–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á"],
            "company_context": {
                "size": "—Å—Ä–µ–¥–Ω—è—è –∫–æ–º–ø–∞–Ω–∏—è",
                "industry": "—Ä–∞–∑–ª–∏—á–Ω—ã–µ –æ—Ç—Ä–∞—Å–ª–∏",
                "culture": "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è"
            },
            "key_terms": ["–æ–ø—ã—Ç", "–Ω–∞–≤—ã–∫–∏", "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º"]
        }
    
    def _get_fallback_resume_analysis(self) -> Dict[str, Any]:
        """Fallback –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—é–º–µ"""
        return {
            "technical_skills": [
                {
                    "skill": "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏",
                    "level": "intermediate",
                    "context": "—Ä–∞–±–æ—á–∞—è –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
                    "results": "—É—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á",
                    "keywords": ["–Ω–∞–≤—ã–∫–∏", "–æ–ø—ã—Ç"]
                }
            ],
            "experience": ["–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã"],
            "achievements": ["–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –∑–∞–¥–∞—á"],
            "education": ["–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ"],
            "additional": ["–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"]
        }
    
    def _get_fallback_matching_analysis(self) -> Dict[str, Any]:
        """Fallback –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π"""
        return {
            "exact_matches": [
                {
                    "vacancy_requirement": "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç",
                    "resume_match": "–∏–º–µ–µ—Ç—Å—è –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã",
                    "evidence": "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è —Ä–µ–∑—é–º–µ",
                    "relevance_score": 0.95,
                    "bridge_explanation": "–∫–∞–∫ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –æ–ø—ã—Ç –ø—Ä–∏–º–µ–Ω–∏–º"
                }
            ],
            "strong_matches": [
                {
                    "vacancy_requirement": "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏",
                    "resume_match": "—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏",
                    "evidence": "–æ–ø–∏—Å–∞–Ω–æ –≤ —Ä–µ–∑—é–º–µ",
                    "relevance_score": 0.8,
                    "bridge_explanation": "–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–≤—è–∑—å"
                }
            ],
            "weak_matches": [],
            "critical_gaps": [],
            "unique_advantages": ["–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞"]
        }

    def _get_fallback_analysis(self) -> Dict[str, Any]:
        """Fallback —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–æ–∫ (—Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç)"""
        return {
            "vacancy_analysis": {
                "key_requirements": ["–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã", "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏"],
                "pain_points": ["–ü–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–µ"],
                "priorities": ["–ö–∞—á–µ—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á"],
                "company_culture": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–∞",
                "urgency_signals": [],
                "hidden_needs": ["–ù–∞–¥–µ–∂–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å"]
            },
            "resume_analysis": {
                "key_skills": ["–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏", "–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã"],
                "achievements": ["–£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á"],
                "unique_advantages": ["–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞"],
                "career_trajectory": "–°—Ç–∞–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ",
                "transferable_skills": ["–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ –º—ã—à–ª–µ–Ω–∏–µ"]
            },
            "matching_strategy": {
                "direct_matches": ["–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º"],
                "skill_gaps": [],
                "positioning": "–ö–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
                "value_proposition": "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ –∏ –æ–ø—ã—Ç",
                "specific_references": ["–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã"]
            },
            "confidence_score": 0.6
        }


# ============ –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† ============

_analyzer_instance: Optional[SmartAnalyzer] = None


def get_analyzer(openai_service=None) -> SmartAnalyzer:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞"""
    global _analyzer_instance
    
    if _analyzer_instance is None:
        if openai_service is None:
            from services.openai_service import openai_service as default_service
            openai_service = default_service
        _analyzer_instance = SmartAnalyzer(openai_service)
    
    return _analyzer_instance


async def analyze_and_generate(
    vacancy_text: str,
    resume_text: str,
    style: str = "professional",
    openai_service=None
) -> str:
    """
    –£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ñ–ª–æ—É (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
    
    Args:
        vacancy_text: –¢–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏
        resume_text: –¢–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ  
        style: –°—Ç–∏–ª—å –ø–∏—Å—å–º–∞
        openai_service: –°–µ—Ä–≤–∏—Å OpenAI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        –ì–æ—Ç–æ–≤–æ–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
    """
    analyzer = get_analyzer(openai_service)
    result = await analyzer.generate_full_analysis_and_letter(vacancy_text, resume_text, style)
    return result['letter']


async def analyze_and_generate_with_analysis(
    vacancy_text: str,
    resume_text: str,
    style: str = "professional",
    openai_service=None
) -> Dict[str, str]:
    """
    –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –∞–Ω–∞–ª–∏–∑–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    
    Args:
        vacancy_text: –¢–µ–∫—Å—Ç –≤–∞–∫–∞–Ω—Å–∏–∏
        resume_text: –¢–µ–∫—Å—Ç —Ä–µ–∑—é–º–µ  
        style: –°—Ç–∏–ª—å –ø–∏—Å—å–º–∞
        openai_service: –°–µ—Ä–≤–∏—Å OpenAI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
    Returns:
        Dict —Å –ø–∏—Å—å–º–æ–º –∏ –∞–Ω–∞–ª–∏–∑–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    """
    analyzer = get_analyzer(openai_service)
    return await analyzer.generate_full_analysis_and_letter(vacancy_text, resume_text, style) 